---
import Layout from '~/layouts/PageLayout.astro';
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import Button from '~/components/ui/Button.astro';

const metadata = {
  title: 'Kontakt',
};

// Pobierz zmienne środowiskowe
const web3formsKey = import.meta.env.PUBLIC_WEB3FORMS_ACCESS_KEY || 'YOUR_ACCESS_KEY_HERE';
---

<Layout metadata={metadata}>
  <WidgetWrapper containerClass="max-w-3xl mx-auto py-12 sm:py-16 lg:py-20">
    <div class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold leading-tighter tracking-tighter mb-4 font-heading">Kontakt</h1>
      <p class="text-xl text-muted dark:text-slate-400">
        Masz pytania? Skontaktuj się za pomocą formularza poniżej.
      </p>
    </div>

    <div
      class="flex flex-col max-w-xl mx-auto rounded-lg backdrop-blur border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 shadow p-6 sm:p-8 lg:p-10"
    >
      <form id="contact-form" class="space-y-6">
        <!-- Web3Forms Access Key -->
        <input type="hidden" name="access_key" value={web3formsKey} />
        
        <!-- Redirect po sukcesie -->
        <input type="hidden" name="redirect" value="false" />
        
        <!-- Honeypot - antyspam (ukryte pole dla botów) -->
        <input type="checkbox" name="botcheck" class="hidden" style="display: none;" />

        <!-- Imię -->
        <div>
          <label for="name" class="block text-sm font-medium mb-2">
            Imię <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="name"
            name="name"
            required
            class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="Twoje imię"
          />
        </div>

        <!-- Email -->
        <div>
          <label for="email" class="block text-sm font-medium mb-2">
            Email <span class="text-red-500">*</span>
          </label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="twoj@email.com"
          />
        </div>

        <!-- Wiadomość -->
        <div>
          <label for="message" class="block text-sm font-medium mb-2">
            Wiadomość <span class="text-red-500">*</span>
          </label>
          <textarea
            id="message"
            name="message"
            rows="6"
            required
            class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="Twoja wiadomość..."></textarea>
        </div>

        <!-- Status wiadomości -->
        <div id="form-status" class="hidden">
          <div
            id="form-success"
            class="hidden p-4 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded-lg"
          >
            ✓ Wiadomość została wysłana pomyślnie!
          </div>
          <div id="form-error" class="hidden p-4 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded-lg">
            <span id="error-message">✗ Wystąpił błąd. Spróbuj ponownie.</span>
          </div>
        </div>

        <!-- Przycisk wysyłania -->
        <div class="grid">
          <Button variant="primary" type="submit" id="submit-btn">Wyślij wiadomość</Button>
        </div>
      </form>
    </div>
  </WidgetWrapper>
</Layout>

<!-- Form Handler -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('contact-form') as HTMLFormElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const formStatus = document.getElementById('form-status') as HTMLElement;
    const successMsg = document.getElementById('form-success') as HTMLElement;
    const errorMsg = document.getElementById('form-error') as HTMLElement;
    const errorText = document.getElementById('error-message') as HTMLElement;

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Ukryj poprzednie komunikaty
      formStatus.classList.add('hidden');
      successMsg.classList.add('hidden');
      errorMsg.classList.add('hidden');

      // Wyłącz przycisk podczas wysyłania
      submitBtn.disabled = true;
      submitBtn.textContent = 'Wysyłanie...';

      try {
        // Przygotuj dane formularza
        const formData = new FormData(form);
        
        // Wyślij przez Web3Forms API
        // Web3Forms automatycznie sprawdza pole "botcheck" (honeypot)
        const response = await fetch('https://api.web3forms.com/submit', {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();

        if (data.success) {
          // Pokaż sukces
          formStatus.classList.remove('hidden');
          successMsg.classList.remove('hidden');
          form.reset();
        } else {
          throw new Error(data.message || 'Błąd wysyłania');
        }
      } catch (error) {
        // Pokaż błąd
        formStatus.classList.remove('hidden');
        errorMsg.classList.remove('hidden');
        errorText.textContent = `✗ ${error instanceof Error ? error.message : 'Wystąpił błąd. Spróbuj ponownie.'}`;
        console.error('Error:', error);
      } finally {
        // Przywróć przycisk
        submitBtn.disabled = false;
        submitBtn.textContent = 'Wyślij wiadomość';
      }
    });
  });
</script>
